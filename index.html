<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pré‑cadastro Inteligente</title>
  <!-- Tailwind para layout rápido -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- OCR & PDF libs -->
  <script src="https://unpkg.com/tesseract.js@v5.0.0/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Configura o worker do pdf.js (obrigatório a partir da v3)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
</head>
<body class="bg-slate-50 text-gray-800 min-h-screen flex flex-col items-center p-4">
  <header class="w-full max-w-2xl mb-6">
    <h1 class="text-2xl font-extrabold text-center">Pré‑cadastro Inteligente</h1>
  </header>

  <!-- Passo 1 -->
  <section id="step1" class="w-full max-w-2xl space-y-4">
    <p class="text-sm text-gray-600">Escaneie seu documento de Identidade (RG ou CNH) e seu comprovante de residência</p>

    <label class="block p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:bg-slate-100">
      <span class="block text-sm font-medium mb-1">Documento de identidade</span>
      <input type="file" id="idFile" accept="application/pdf,image/*" capture="environment" class="w-full" />
    </label>

    <label class="block p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:bg-slate-100">
      <span class="block text-sm font-medium mb-1">Comprovante de residência</span>
      <input type="file" id="addressFile" accept="application/pdf,image/*" capture="environment" class="w-full" />
    </label>

    <button id="scanBtn" class="w-full py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors">Escanear Documentos</button>
  </section>

  <!-- Passo 2 -->
  <section id="step2" class="w-full max-w-2xl hidden flex-col items-center space-y-4">
    <h2 class="text-xl font-semibold">Analisando…</h2>
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-600 border-t-transparent"></div>
    <p class="text-sm text-gray-600">Aguarde um momento enquanto os seus dados são extraídos</p>
  </section>

  <!-- Passo 3 -->
  <section id="step3" class="w-full max-w-2xl hidden space-y-4">
    <h2 class="text-xl font-semibold">Confirme seus Dados</h2>
    <form id="identityForm" class="space-y-2">
      <label class="block">Nome <input name="nome" class="input"></label>
      <label class="block">Data de Nascimento <input name="dob" class="input"></label>
      <label class="block">CPF <input name="cpf" class="input"></label>
      <label class="block">Naturalidade <input name="naturalidade" class="input"></label>
      <label class="block">Nome da Mãe <input name="mae" class="input"></label>
    </form>
    <button id="nextToAddress" class="w-full py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors">Próximo</button>

    <details class="mt-2">
      <summary class="cursor-pointer text-indigo-700">Texto bruto OCR (debug)</summary>
      <pre id="rawTextId" class="whitespace-pre-wrap text-sm bg-slate-100 p-2 rounded"></pre>
    </details>
  </section>

  <!-- Passo 4 -->
  <section id="step4" class="w-full max-w-2xl hidden space-y-4">
    <h2 class="text-xl font-semibold">Dados Residenciais</h2>
    <form id="addressForm" class="space-y-2">
      <label class="block">Endereço completo <input name="endereco" class="input" /></label>
    </form>
    <button id="sendBtn" class="w-full py-3 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700 transition-colors">Enviar Contrato</button>

    <details class="mt-2">
      <summary class="cursor-pointer text-indigo-700">Texto bruto OCR (endereço)</summary>
      <pre id="rawTextAddr" class="whitespace-pre-wrap text-sm bg-slate-100 p-2 rounded"></pre>
    </details>
  </section>

  <!-- Passo 5 -->
  <section id="step5" class="w-full max-w-2xl hidden text-center space-y-4">
    <h2 class="text-xl font-semibold">✅ Pré‑cadastro concluído!</h2>
    <p class="text-gray-700">Obrigado. Você receberá o contrato por SMS.</p>
  </section>

  <script>
    /* ---------- helpers ---------- */
    const \$ = (sel) => document.querySelector(sel);
    const show = (id) => document.getElementById(id).classList.remove("hidden");
    const hide = (id) => document.getElementById(id).classList.add("hidden");

    /** Remove acentos, quebra de linha duplicada etc. */
    function normalizeText(raw) {
      return raw
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toUpperCase();
    }

    /** Regex simples para CNH/RG (ajuste conforme padrões locais) */
    function parseIdText(raw) {
      const txt = normalizeText(raw);
      const result = {};
      // Nome = maior sequência de letras
      const maybeNames = txt.match(/[A-Z ]{10,}/g) || [];
      result.nome = maybeNames.sort((a, b) => b.length - a.length)[0]?.trim() || "";
      // Data nascimento (DD/MM/AAAA)
      result.dob = (txt.match(/([0-3]?\d\/[01]?\d\/[12]\d{3})/) || [])[1] || "";
      // CPF 11 dígitos
      result.cpf = (txt.match(/\b\d{3}\.\d{3}\.\d{3}-\d{2}\b|\b\d{11}\b/) || [])[0] || "";
      return result;
    }

    /** Regex super‑simples para endereço (pode melhorar depois) */
    function parseAddressText(raw) {
      const txt = normalizeText(raw);
      const line = txt.split(/\n|\r/).find((l) => l.includes("RUA") || l.includes("AV") || l.includes("TRAV")) || "";
      return { endereco: line.trim() };
    }

    /* ---------- OCR pipeline ---------- */
    async function ocrFile(file) {
      // Se for PDF ➜ converte primeira página em canvas imagem
      if (file.type === "application/pdf") {
        const data = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        const { data: { text } } = await Tesseract.recognize(canvas, "por");
        return text;
      }
      // Imagem comum
      const { data: { text } } = await Tesseract.recognize(file, "por");
      return text;
    }

    /* ---------- fluxo ---------- */
    $("#scanBtn").addEventListener("click", async () => {
      const idFile = $("#idFile").files[0];
      const addrFile = $("#addressFile").files[0];
      if (!idFile) return alert("Selecione o documento de identidade.");
      if (!addrFile) return alert("Selecione o comprovante de residência.");

      hide("step1"); show("step2");
      try {
        // OCR identidade
        const idText = await ocrFile(idFile);
        $("#rawTextId").textContent = idText;
        const idData = parseIdText(idText);
        for (const [k, v] of Object.entries(idData)) {
          if (v) $("#identityForm").elements[k].value = v;
        }

        // OCR endereço
        const addrText = await ocrFile(addrFile);
        $("#rawTextAddr").textContent = addrText;
        const addrData = parseAddressText(addrText);
        if (addrData.endereco) $("#addressForm").elements["endereco"].value = addrData.endereco;

        hide("step2"); show("step3");
      } catch (err) {
        console.error(err);
        alert("Falha ao ler arquivos. Tente novamente.");
        hide("step2"); show("step1");
      }
    });

    $("#nextToAddress").addEventListener("click", () => {
      hide("step3"); show("step4");
    });

    $("#sendBtn").addEventListener("click", () => {
      hide("step4"); show("step5");
    });
  </script>
</body>
</html>
